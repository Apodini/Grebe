//
//  File.swift
//
//
//  Created by Tim Mewe on 14.01.20.
//

import SwiftProtobuf
import SwiftProtobufPluginLibrary

class Generator {
    private var printer: CodePrinter
    internal var file: FileDescriptor
    internal var service: ServiceDescriptor! // context during generation
    internal var method: MethodDescriptor! // context during generation
    internal let protobufNamer: SwiftProtobufNamer

    init(_ file: FileDescriptor) {
        self.file = file
        printer = CodePrinter()
        protobufNamer = SwiftProtobufNamer(
            currentFile: file,
            protoFileToModuleMappings: ProtoFileToModuleMappings()
        )

        printMain()
    }

    public var code: String {
        return printer.content
    }

    private func printMain() {
        printer.print("""
        //
        // DO NOT EDIT.
        //
        // Generated by the protocol buffer compiler.
        // Source: \(file.name)
        //
        """)

        let moduleNames = [
            "Grebe_Framework"
        ]

        for moduleName in moduleNames.sorted() {
            println("import \(moduleName)")
        }

        for service in file.services {
            self.service = service
            printGrebe()
        }
    }

    internal func println(_ text: String = "") {
        printer.print(text)
        printer.print("\n")
    }

    internal func indent() {
        printer.indent()
    }

    internal func outdent() {
        printer.outdent()
    }
}
